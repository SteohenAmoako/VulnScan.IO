
'use server';
/**
 * @fileOverview Summarizes a vulnerability scan report into key takeaways.
 *
 * - summarizeVulnerabilityReport - A function that handles the summarization process.
 * - SummarizeVulnerabilityReportInput - The input type for the summarizeVulnerabilityReport function.
 * - SummarizeVulnerabilityReportOutput - The return type for the summarizeVulnerabilityReport function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const SummarizeVulnerabilityReportInputSchema = z.object({
  report: z.string().describe('The main vulnerability scan report in JSON format, containing an array of vulnerability objects.'),
  isHttps: z.boolean().describe('Whether the website uses HTTPS.'),
  urlParamFindings: z.array(z.object({
    key: z.string(),
    value: z.string(),
    matches: z.array(z.string()),
  })).describe('Findings from the URL parameter analysis, including any malicious patterns detected.'),
});
export type SummarizeVulnerabilityReportInput = z.infer<typeof SummarizeVulnerabilityReportInputSchema>;

const SummarizeVulnerabilityReportOutputSchema = z.object({
  summary: z.string().describe('A concise, holistic summary of all vulnerability findings. Explain the overall security posture and potential risks in an easy-to-understand way.'),
});
export type SummarizeVulnerabilityReportOutput = z.infer<typeof SummarizeVulnerabilityReportOutputSchema>;

export async function summarizeVulnerabilityReport(input: SummarizeVulnerabilityReportInput): Promise<SummarizeVulnerabilityReportOutput> {
  return summarizeVulnerabilityReportFlow(input);
}

const prompt = ai.definePrompt({
  name: 'summarizeVulnerabilityReportPrompt',
  input: {schema: SummarizeVulnerabilityReportInputSchema},
  output: {schema: SummarizeVulnerabilityReportOutputSchema},
  prompt: `You are an expert security analyst. Your task is to provide a holistic summary of a website's security posture based on a structured JSON report. A non-technical user needs to quickly understand the findings, risk levels, and the most important actions to take.

Here is the data you have been given:

1.  **Structured Vulnerability Report (JSON format):**
    {{{report}}}

2.  **HTTPS Status:**
    The website is {{#if isHttps}}using HTTPS (secure){{else}}NOT using HTTPS (insecure){{/if}}.

3.  **URL Parameter Analysis:**
    {{#if urlParamFindings.length}}
        The following potential issues were found in the URL's parameters:
        {{#each urlParamFindings}}
            {{#if this.matches.length}}
                - The parameter "{{this.key}}" with value "{{this.value}}" triggered the following alerts: {{#each this.matches}}{{{this}}}{{#unless @last}}, {{/unless}}{{/each}}.
            {{/if}}
        {{/each}}
    {{else}}
        No issues were found in the URL parameters.
    {{/if}}

Please synthesize all of this information into a single, easy-to-read executive summary. 
- Start by describing the overall security posture (e.g., 'weak', 'moderate', 'strong') based on the severity of the findings in the JSON report.
- Explain the key takeaways and what the biggest risks are, referencing the most critical vulnerabilities found.
- Conclude with a clear, prioritized list of the top 2-3 most important recommendations.
- State the single most important next step the user should take.
`,
});

const summarizeVulnerabilityReportFlow = ai.defineFlow(
  {
    name: 'summarizeVulnerabilityReportFlow',
    inputSchema: SummarizeVulnerabilityReportInputSchema,
    outputSchema: SummarizeVulnerabilityReportOutputSchema,
  },
  async input => {
    const {output} = await prompt(input);
    return output!;
  }
);
